# Elasticsearch
- ê²€ìƒ‰ì´ë‘ ë°ì´í„°ë¶„ì„ì— ìµœì í™”ëœ ë°ì´í„°ë² ì´ìŠ¤

<br>

## âœ… ì£¼ìš” í™œìš© ì‚¬ë¡€
1. ê²€ìƒ‰ ìµœì í™”
    - ë°ì´í„°ê°€ ë§ë”ë¼ë„ ë›°ì–´ë‚œ ê²€ìƒ‰ ì†ë„ë¥¼ ê°€ì§€ê³  ìˆê³ , ì˜¤íƒ€ë‚˜ ë™ì˜ì–´ë¥¼ ê³ ë ¤í•´ì„œ ìœ ì—°í•˜ê²Œ ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆë‹¤
    - ì¿ íŒ¡ì´ë‚˜ ë°°ë‹¬ì˜ ë¯¼ì¡±ì˜ ê²€ìƒ‰ ê¸°ëŠ¥ë„ Elasticsearch í™œìš©
2. ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„
    - ëŒ€ê·œëª¨ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ë° ë¶„ì„í•˜ëŠ”ë° ìµœì í™”ë˜ì–´ ìˆë‹¤


<br>

## ğŸ“ ê°„ë‹¨ ìš©ì–´ ëŒ€ì‘í‘œ: RDB vs Elasticsearch

| RDB (ê´€ê³„í˜• DB)               | Elasticsearch                   |
| ----------------------------- | ------------------------------- |
| **Database**                  | **Index**                       |
| **Table**                     | **Type** (â† í˜„ì¬ëŠ” ê±°ì˜ íì§€ë¨) |
| **Row**                       | **Document**                    |
| **Column**                    | **Field**                       |
| **Schema**                    | **Mapping**                   |
| **DBMS ì„œë²„ ì „ì²´**            | **Cluster**                     |
| **DB ì„œë²„ì˜ ë¬¼ë¦¬ì  ì¸ìŠ¤í„´ìŠ¤** | **Node**                        |

<br>

### Elasticsearch ìš©ì–´
- **ì¸ë±ìŠ¤** : ê´€ë ¨ ë¬¸ì„œë¥¼ ì €ì¥í•˜ê³  êµ¬ì¡°í™”í•˜ëŠ” ì¥ì†Œ
    - **ìƒ¤ë“œ** : ìƒ‰ì¸ ë° ê²€ìƒ‰ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë£¨ì”¬ ì¸ë±ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë‹¤
    - ì¸ë±ìŠ¤ëŠ” í”„ë¼ì´ë¨¸ë¦¬ ìƒ¤ë“œ, ë ˆí”Œë¦¬ì¹´ ìƒ¤ë“œë¡œ êµ¬ì„±ëœë‹¤
    - **í”„ë¼ì´ë¨¸ë¦¬ ìƒ¤ë“œ**
        - ì½ê¸° ë° ì“°ê¸° ìš”ì²­ì„ ëª¨ë‘ ì²˜ë¦¬
    - **ë ˆí”Œë¦¬ì¹´ ìƒ¤ë“œ**
        - ì½ê¸° ì „ìš©
    - í”„ë¼ì´ë¨¸ë¦¬ ë° ë ˆí”Œë¦¬ì¹´ ìƒ¤ë“œëŠ” í•­ìƒ ì„œë¡œ ë‹¤ë¥¸ ë…¸ë“œì— í• ë‹¹ë˜ì–´ ë‹¤ì¤‘ì„±ê³¼ í™•ì¥ì„±ì„ ì œê³µ
    - | ì†ì‹¤ ìƒí™©                               | ì‹œìŠ¤í…œ ë™ì‘                                                  | ì˜í–¥                                | ìë™ ë³µêµ¬ ì—¬ë¶€ |
        | --------------------------------------- | ------------------------------------------------------------ | ----------------------------------- | -------------- |
        | **Primary Shard ì†ì‹¤ (Replica ì¡´ì¬)** | í´ëŸ¬ìŠ¤í„°ê°€ **Replicaë¥¼ ìƒˆë¡œìš´ Primaryë¡œ ìŠ¹ê²©**               | âœ… ì„œë¹„ìŠ¤ ìœ ì§€ ê°€ëŠ¥ (ì½ê¸°/ì“°ê¸° ê°€ëŠ¥) | âœ… ìë™ ë³µêµ¬    |
        | **Replica Shard ì†ì‹¤ (Primary ì¡´ì¬)** | PrimaryëŠ” ì •ìƒì´ë¯€ë¡œ ì˜í–¥ ì—†ìŒ Replicaë¥¼ ë‹¤ì‹œ ë‹¤ë¥¸ ë…¸ë“œì— **ìë™ ìƒì„±** | âœ… ì„œë¹„ìŠ¤ ì§€ì† ê°€ëŠ¥ (ì½ê¸°/ì“°ê¸° ê°€ëŠ¥) | âœ… ìë™ ë³µêµ¬    |
        | **Primary + Replica ëª¨ë‘ ì†ì‹¤**       | í•´ë‹¹ ìƒ¤ë“œì˜ ë°ì´í„° ì™„ì „ ì†Œì‹¤ ê²€ìƒ‰/ìƒ‰ì¸ ë¶ˆê°€                  | âŒ ë°ì´í„° ì†ì‹¤ ì„œë¹„ìŠ¤ ì¥ì•  ë°œìƒ      | âŒ ë¶ˆê°€ëŠ¥       |
- **ìƒ‰ì¸(Indexing)** : ë¬¸ì„œë¥¼ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì¸ë±ìŠ¤ì— ê¸°ë¡í•˜ëŠ” ì‘ì—…
- **document(ë¬¸ì„œ)** : ì¸ë±ìŠ¤ì— ì €ì¥ëœ JSON ê°ì²´
- **ë§¤í•‘** : ì¸ë±ìŠ¤ ë‚´ í•„ë“œë“¤ì˜ êµ¬ì¡°/ë°ì´í„°í˜•ì„ ì •ì˜, ê° í•„ë“œì˜ ë°ì´í„° ìœ í˜•ì„ ì§€ì •í•˜ê³  ê²€ìƒ‰ì„ ìœ„í•´ í•„ë“œë¥¼ ìƒ‰ì¸í•˜ê³  ë¶„ì„í•˜ëŠ” ë°©ë²•ì„ ê²°ì •
- **ë…¸ë“œ** : ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ì˜ ë‹¨ì¼ ì‹¤í–‰ ì¸ìŠ¤í„´ìŠ¤(í•˜ë‚˜ì˜ ì‹¤í–‰ ë‹¨ìœ„)

<br>

## ë‚´ë¶€ êµ¬ì¡°
```scss
í´ëŸ¬ìŠ¤í„°
 â”œâ”€ ë…¸ë“œ A
 â”‚   â”œâ”€ ìƒ¤ë“œ: products ì¸ë±ìŠ¤ì˜ Primary-0
 â”‚   â””â”€ ìƒ¤ë“œ: logs ì¸ë±ìŠ¤ì˜ Replica-2
 â”œâ”€ ë…¸ë“œ B
 â”‚   â””â”€ ìƒ¤ë“œ: products ì¸ë±ìŠ¤ì˜ Replica-0
 â”‚
â””â”€ ì¸ë±ìŠ¤
    â”œâ”€ products (2 primary shards, 1 replica each)
    â”‚    â”œâ”€ Primary-0 â†’ Node A
    â”‚    â”œâ”€ Primary-1 â†’ Node B
    â”‚    â”œâ”€ Replica-0 â†’ Node B
    â”‚    â””â”€ Replica-1 â†’ Node A
    â””â”€ logs ...
```
- ì¸ë±ìŠ¤ëŠ” ì—¬ëŸ¬ ê°œì˜ ìƒ¤ë“œë¡œ ë‚˜ë‰˜ê³ ,
- ì´ ìƒ¤ë“œë“¤ì´ í´ëŸ¬ìŠ¤í„° ë‚´ ì—¬ëŸ¬ ë…¸ë“œì— ë¶„ì‚° ì €ì¥ëœë‹¤

<br>

## ğŸ” ë°ì´í„° ìƒ‰ì¸ê³¼ ê²€ìƒ‰

<br>

### ì¸ë±ì‹±ê³¼ ê²€ìƒ‰ ì„±ëŠ¥ ìµœì í™”
- ê¸°ë³¸ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•  ë•Œ
    - Primary Shard (ê¸°ë³¸ ìƒ¤ë“œ): 1ê°œ
    - Replica Shard (ë³µì œ ìƒ¤ë“œ): 1ê°œ (Primary Shardì˜ ë³µì œë³¸)
- ì¸ë±ìŠ¤ëŠ” ì—¬ëŸ¬ ê°œì˜ ìƒ¤ë“œë¡œ êµ¬ì„±ë  ìˆ˜ ìˆë‹¤
- ìƒ¤ë“œ ê°œìˆ˜ê°€ ëŠ˜ì–´ë‚ ìˆ˜ë¡ ë°ì´í„°ì˜ **í™•ì¥ì„±, ì„±ëŠ¥, ì•ˆì •ì„±**ì— ì§ê²°ëœë‹¤
- ë„ˆë¬´ ì‘ì€ ë°ì´í„°ì— ìƒ¤ë“œë¥¼ ë§ì´ ë§Œë“¤ë©´ ì˜¤íˆë ¤ ëŠë ¤ì§€ê³  ë¹„íš¨ìœ¨ì ì´ë‹¤

<br>

ì°¸ê³ 
> ë ˆí”Œë¦¬ì¹´ ì¹´ë“œëŠ” ê° í”„ë¼ì´ë¨¸ë¦¬ ìƒ¤ë“œë§ˆë‹¤ í• ë‹¹ëœë‹¤.   
> ì˜ˆë¡œëŠ” 2ê°œì˜ í”„ë¼ì´ë¨¸ë¦¬ ìƒ¤ë“œ, 1ê°œì˜ ë ˆí”Œë¦¬ì¹´ ìƒ¤ë“œë©´ ì´ 4ê°œì˜ ìƒ¤ë“œ í• ë‹¹ëœë‹¤(ê° í”„ë¼ì´ë¨¸ë¦¬ ìƒ¤ë“œë§ˆë‹¤ 1ê°œì˜ ë ˆí”Œë¦¬ì¹´ ìƒ¤ë“œ)   
> 2ê°œ í”„ë¼ì´ë¨¸ë¦¬, 2ê°œì˜ ë ˆí”Œë¦¬ì¹´ ì¸ë±ìŠ¤ëŠ” ì´ 6ê°œ ìƒ¤ë“œë¡œ êµ¬ì„±

<br>

ë”°ë¼ì„œ
- ê²€ìƒ‰ ì„±ëŠ¥ ìµœì í™” í•˜ë ¤ë©´ ìƒ¤ë“œë¥¼ ì „ì²´ ë…¸ë“œì— ê· ë“±í•˜ê²Œ ë¶„ì‚°í•´ì•¼ í•œë‹¤
- 30GB ~ 50GB ì‚¬ì´ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ê²ƒì„ ê¶Œì¥
    - ì˜ˆë¡œëŠ”
    - ê³ ì„±ëŠ¥ ê²€ìƒ‰ -> ì‘ì€ ìƒ¤ë“œê°€ ë¹ ë¥¸ ê²€ìƒ‰ê³¼ ì§‘ê³„ì— ì´ì 
    - ë¡œê¹… ì‘ì—… -> í´ëŸ¬ìŠ¤í„°ì— ë§ì€ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ìˆê²Œ í° ìƒ¤ë“œê°€ ì í•©

<br>

### ì£¼ìš” ë°ì´í„° íƒ€ì…ë“¤ 

| íƒ€ì…                       | ì„¤ëª…                                     |
| -------------------------- | ---------------------------------------- |
| `text`                     | ì „ì²´ í…ìŠ¤íŠ¸ ê²€ìƒ‰ìš© (ex. ì œí’ˆëª…, ì„¤ëª… ë“±) |
| `keyword`                  | ì •ë ¬/ì§‘ê³„ìš© ë¬¸ìì—´ (ex. ì¹´í…Œê³ ë¦¬, ID ë“±) |
| `integer`, `float`, `long` | ìˆ«ìí˜• ë°ì´í„°                            |
| `boolean`                  | true / false                             |
| `date`                     | IPv4, IPv6                              |
| `geo_point`                | ìœ„ë„/ê²½ë„ ì¢Œí‘œ                           |
| `object`                   | JSON ë¬¸ì„œì— ë‚´ë¶€ ê°ì²´                    |
| `array`                    | ë°°ì—´, í•˜ë‚˜ì˜ ë°°ì—´ì€ ë‹¨ì¼ ë°ì´í„°ë§Œ ë³´ìœ      |
| `nested`                   | ì¤‘ì²© íƒ€ì…, ê°ì²´ ë‚´ë¶€ì˜ ì—°ê´€ì„± ì •ë³´ ìœ ì§€    |
| `join`                     | ë¬¸ì„œ ê°„ì— ë¶€ëª¨/ìì‹ ê´€ê³„ë¥¼ ë§Œë“¬           |

<br>

### ë¬¸ì„œ ID ìƒì„±
- ìë™ìœ¼ë¡œ ë¬¸ì„œ ID ìƒì„±í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì´ë©° ìƒ‰ì¸ ì„±ëŠ¥ë„ í–¥ìƒëœë‹¤
    - ë²”ìš© ê³ ìœ  ì‹ë³„ì(UUID)ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ
- ë°˜ë©´, IDë¥¼ ì§ì ‘ ì„¤ì •í•˜ë©´ ìƒ‰ì¸ ì‘ì—…ì„ í•˜ê¸° ì „ì— ë™ì¼í•œ _id í”„ë¼ì´ë¨¸ë¦¬ ìƒ¤ë“œì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì‘ì—…ì„ ì§„í–‰

<br>

### ë§¤í•‘
- ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ëŠ” ìë™ìœ¼ë¡œ ë™ì  ì¸ë±ìŠ¤ ë§¤í•‘ì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤
- ì¸ë±ìŠ¤ ë§¤í•‘ì€ ì œê±°í•˜ê±°ë‚˜ ë³€ê²½í•  ìˆ˜ ì—†ë‹¤
- ë”°ë¼ì„œ ì¸ë±ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì•Œê³  ìˆë‹¤ë©´ ì¸ë±ìŠ¤ ë§¤í•‘ì„ ì •ì˜í•˜ëŠ”ê²Œ ì¢‹ë‹¤

<br>

### ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ë…¸ë“œ
| ë…¸ë“œ ì¢…ë¥˜                                 | ì—­í•                                                          | ì„¤ì • í‚¤                              |
| ----------------------------------------- | ------------------------------------------------------------ | ------------------------------------ |
| ğŸŒ **ë§ˆìŠ¤í„° ë…¸ë“œ (Master Node)**           | í´ëŸ¬ìŠ¤í„° ìƒíƒœ ê´€ë¦¬, ë…¸ë“œ ì¶”ê°€/ì œê±°, ì¸ë±ìŠ¤ ìƒì„± ë“± **ì „ì²´ ì œì–´ ì—­í• ** | `node.roles: [ master ]`             |
| ğŸ“¦ **ë°ì´í„° ë…¸ë“œ (Data Node)**             | ì‹¤ì œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ , ìƒ‰ì¸(indexing), ê²€ìƒ‰(query) ì²˜ë¦¬ ë‹´ë‹¹ | `node.roles: [ data ]`               |
| ğŸ›  **ì¸ì œìŠ¤íŠ¸ ë…¸ë“œ (Ingest Node)**         | ìƒ‰ì¸ ì „ì— ë°ì´í„°ë¥¼ ì „ì²˜ë¦¬(íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë“±)                | `node.roles: [ ingest ]`             |
| ğŸ’¬ **ì½”ë””ë„¤ì´íŒ… ë…¸ë“œ (Coordinating Node)** | ì‚¬ìš©ìê°€ ë³´ë‚¸ ìš”ì²­ì„ ë‹¤ë¥¸ ë…¸ë“œì— ì „ë‹¬í•˜ê³  ê²°ê³¼ë¥¼ ì¢…í•© â†’ **í”„ë¡ì‹œ ì—­í• ** | ì—­í•  ì—†ìŒ (`node.roles` ë¹„ì›Œë‘ë©´ ë¨) |
| ğŸ“ **ë¨¸ì‹ ëŸ¬ë‹ ë…¸ë“œ (ML Node)**             | ë¨¸ì‹ ëŸ¬ë‹ ë¶„ì„ (anomaly detection ë“±) ë‹´ë‹¹                    | `node.roles: [ ml ]`                 |

<br>

### ì˜ˆì œ ì½”ë“œë“¤
```shell
PUT /my-index
GET my-index
GET _cat/indices
PUT my-other-index
PUT my-other-index2
{
  "settings": {
    "index": {
      "number_of_shards": 3,
      "number_of_replicas": 1
    }
  }
}
GET _cat/shards/my-other-index2?v
PUT my-index/_doc/2
{
  "city": "Japan"
}
GET my-index/_search
POST my-index/_doc/
{
  "city": 11.1
}
GET my-index/_mapping
PUT my-explicit-index
{
  "mappings": {
    "properties": {
      "year": {
        "type": "integer"
      },
      "city": {
        "type": "keyword"
      },
      "population_M": {
        "type": "float"
      },
      "attrations": {
        "type": "text"
      }
    }
  }
}
POST my-explicit-index/_doc
{
  "year": "aa",
  "city": "AA",
  "population_M":2.0,
  "attrations": "Queen"
}

GET my-explicit-index/_search

PUT stores
{
  "mappings": {
    "properties": {
      "suburb": {
        "type": "keyword"
      },
      "product": {
        "type": "nested"
      }
    }
  }
}

POST stores/_doc
{
  "suburb": "Carlton",
  "product": [
    {
      "product": "i20 Hatch",
      "quantity":21
    },
    {
      "product": "i30 Sport",
      "quantity":300
    }
  ]
}

GET stores/_search
{
  "query": {
    "nested": {
      "path": "product",
      "query": {
        "bool": {
          "must": [
            {"match": {"product.product.keyword": "i30 Sport"}}
          ]
        }
      }
    }
  }
}

PUT department-employees
{
  "mappings": {
    "properties": {
      "dept_id": { "type": "keyword"},
      "dept_name": {"type": "keyword"},
      "employee_id": {"type": "keyword"},
      "employee_name": {"type": "keyword"},
      "doc_type": {
        "type": "join",
        "relations": {
          "department": "employee"
        }
      }
    }
  }
}

PUT department-employees/_doc/d3
{
  "dept_id": "D003",
  "dept_name": "IT",
  "doc_type": "department"
}

PUT department-employees/_doc/e1?routing=1
{
  "employee_id": "E002",
  "employee_name": "James",
  "doc_type": {
    "name": "employee",
    "parent": "d3"
  }
}

PUT department-employees/_doc/e2?routing=1
{
  "employee_id": "E003",
  "employee_name": "Sara",
  "doc_type": {
    "name": "employee",
    "parent": "d3"
  }
}

GET department-employees/_search
{
  "query": {
    "has_parent": {
      "parent_type": "department",
      "query": {
        "term": {
          "dept_name": {
            "value": "IT"
          }
        }
      }
    }
  }
}
```

<br>

### ìƒ˜í”Œ ë¡œê·¸ ìƒ‰ì¸
1. 3ê°œ íŒŒì¼ ìƒì„±
```sh
#!/bin/bash
printf "\n**Load.sh loads an index template and an ingest pipeline to process Apache web logs into Elasticsearch**\n\n"
echo -n "Elasticsearch cluster URL: "
read url
echo -n "Username: "
read username
echo -n "Password: "
read -s password
echo

# load index template
if curl -k -f -XPUT "$url/_index_template/web-logs" -u $username:$password -H 'Content-Type: application/json' -d "@web-logs-template.json"
then echo " - Loaded index template for web logs"
else echo " Could not load index template"
exit
fi

# load ingest pipeline
if curl -k -f -XPUT "$url/_ingest/pipeline/web-logs" -u $username:$password -H 'Content-Type: application/json' -d "@web-logs-pipeline.json"
then echo " - Loaded ingest pipeline for Apache"
else echo " Could not load ingest pipeline for Apache"
exit
fi

printf "\n*Loaded components successfully\n"
```
load.sh

<br>

```sh
https://github.com/wikibook/es80/tree/main/Chapter3
```
- í•´ë‹¹ ì£¼ì†Œì—ì„œ `web-logs-template.json`, `web-logs-pipeline.json` ë‹¤ìš´

<br><br>

2. ê°™ì€ í´ë”ì— ìœ„ 3ê°œì˜ íŒŒì¼ì„ ìƒì„±ì‹œí‚¨ í›„ `./load.sh` ì‹¤í–‰
- urlì€ `https://localhost:9200`
    - `/etc/elasticsearch/elasticsearch.yml`ì— ì•„ë˜ í•­ëª©ì´ ìˆë‹¤ë©´ `https://`ë¡œ ì ‘ì†
    ```sh
    xpack.security.http.transport.enabled: true
    ``` 

<br>

ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ì„±ê³µ

<img src="../resources/log/elastic_load.png">

<br><br>

3. ë¡œê·¸ìŠ¤íƒœì‹œ ë‹¤ìš´
```sh
curl -O https://artifacts.elastic.co/downloads/logstash/logstash-8.14.0-linux-x86_64.tar.gz
```
ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ë©´ .tar ì•„ì¹´ì´ë¸Œ íŒŒì¼ì˜ ì••ì¶•ì„ í‘¼ë‹¤
```sh
tar -xzf logstash-8.14.0-linux-x86_64.tar.gz
```